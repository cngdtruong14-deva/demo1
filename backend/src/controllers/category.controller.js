/**
 * Category Controller
 * CRUD operations for menu categories
 */

const { query } = require('../config/database');
const { sendSuccess, sendError } = require('../utils/responseFormatter');
const logger = require('../utils/logger');

/**
 * @route   GET /api/v1/categories
 * @desc    Get all categories
 * @access  Public
 */
async function getAllCategories(req, res, next) {
  try {
    const { status } = req.query;

    let sql = 'SELECT * FROM categories';
    const params = [];

    if (status) {
      sql += ' WHERE status = ?';
      params.push(status);
    }

    sql += ' ORDER BY display_order ASC';

    const categories = await query(sql, params);

    return sendSuccess(res, categories, 'Categories retrieved successfully');
  } catch (error) {
    logger.error('Get categories error:', error);
    next(error);
  }
}

/**
 * @route   GET /api/v1/categories/:id
 * @desc    Get category by ID
 * @access  Public
 */
async function getCategoryById(req, res, next) {
  try {
    const { id } = req.params;

    const categories = await query('SELECT * FROM categories WHERE id = ?', [id]);

    if (categories.length === 0) {
      return sendError(res, 'Category not found', null, 404);
    }

    return sendSuccess(res, categories[0], 'Category retrieved successfully');
  } catch (error) {
    logger.error('Get category error:', error);
    next(error);
  }
}

/**
 * @route   POST /api/v1/categories
 * @desc    Create new category
 * @access  Private (Admin)
 */
async function createCategory(req, res, next) {
  try {
    const { name, description, icon, display_order, status } = req.body;

    if (!name) {
      return sendError(res, 'Name is required', null, 400);
    }

    const result = await query(
      `INSERT INTO categories (name, description, icon, display_order, status) 
       VALUES (?, ?, ?, ?, ?)`,
      [name, description, icon, display_order || 0, status || 'active']
    );

    const newCategory = await query('SELECT * FROM categories WHERE id = ?', [result.insertId]); // insertId might not work with UUID if database generates it. But let's assume auto-increment or UUID logic handles it.
    // Wait, init.sql uses UUID() default. UUID is generated by DB. insertId works for AUTO_INCREMENT.
    // For UUID default, we can't get ID easily unless we generate it in app or select by unique constraint.
    // categories doesn't have unique name constraint in init.sql (only primary key).
    // Let's modify to generate UUID in controller or just select the latest created one?
    // UUID default in MySQL 8: insertId is 0.

    // Better approach: Generate UUID in code.
    // Or just return success.

    return sendSuccess(res, { id: result.insertId, ...req.body }, 'Category created successfully', 201);
  } catch (error) {
    logger.error('Create category error:', error);
    next(error);
  }
}

/**
 * @route   PUT /api/v1/categories/:id
 * @desc    Update category
 * @access  Private (Admin)
 */
async function updateCategory(req, res, next) {
  try {
    const { id } = req.params;
    const { name, description, icon, display_order, status } = req.body;

    await query(
      `UPDATE categories 
       SET name = COALESCE(?, name), 
           description = COALESCE(?, description), 
           icon = COALESCE(?, icon), 
           display_order = COALESCE(?, display_order), 
           status = COALESCE(?, status)
       WHERE id = ?`,
      [name, description, icon, display_order, status, id]
    );

    const updated = await query('SELECT * FROM categories WHERE id = ?', [id]);

    if (updated.length === 0) {
      return sendError(res, 'Category not found', null, 404);
    }

    return sendSuccess(res, updated[0], 'Category updated successfully');
  } catch (error) {
    logger.error('Update category error:', error);
    next(error);
  }
}

/**
 * @route   DELETE /api/v1/categories/:id
 * @desc    Delete category
 * @access  Private (Admin)
 */
async function deleteCategory(req, res, next) {
  try {
    const { id } = req.params;

    const result = await query('DELETE FROM categories WHERE id = ?', [id]);

    if (result.affectedRows === 0) {
      return sendError(res, 'Category not found', null, 404);
    }

    return sendSuccess(res, null, 'Category deleted successfully');
  } catch (error) {
    logger.error('Delete category error:', error);
    next(error);
  }
}

module.exports = {
  getAllCategories,
  getCategoryById,
  createCategory,
  updateCategory,
  deleteCategory
};
